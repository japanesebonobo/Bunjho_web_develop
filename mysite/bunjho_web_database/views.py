from django.db.models import Q
from django.shortcuts import render
from .models import Allsubjectdata
from .forms import SearchFormSet
from .models import User

# Create your views here.
def index_page(request):
    data = Allsubjectdata.objects.all().values('subjectname','teacher','units','member','a','b','c','d','f','averagegpa','link').distinct().order_by('subjectno')
    formset = SearchFormSet(request.POST or None)
    if request.method == 'POST':
        formset.is_valid()
        queries = []

        for form in formset:
            q_kwargs = {}
            faculty = form.cleaned_data.get('faculty')
            if faculty:
                q_kwargs['faculty'] = faculty
                q = Q(**q_kwargs)
                queries.append(q)
            subjectno = form.cleaned_data.get('subjectno')
            if subjectno == 'h':
                q_kwargs['subjectno'] = subjectno
                q = Q(subjectno__in=['10806011','10806012-001','10806012-002','10806013','10806021','10806022','10806031-002','10806031-007','10806031-010','10806031-011','10806031-012','10806031-015','10806031-016','10806031-017','10806031-019','10806031-021','10806031-024','10806031-025','10806031-027','10806031-028','10806031-029','10806031-030','10806032-002','10806032-007','10806032-010','10806032-011','10806032-012','10806032-015','10806032-016','10806032-017','10806032-019','10806032-021','10806032-024','10806032-025','10806032-027','10806032-028','10806032-029','10806032-030','10806033-001','10806033-002','10806041-001','10806041-002','10806041-003','10806041-004','10806041-005','10806041-008','10806041-011','10806041-012','10806041-014','10806041-016','10806041-017','10806041-018','10806041-019','10806041-021','10806041-022','10806041-023','10806041-024','10806041-025','10806041-026','10806041-028','10806041-033','10806041-034','10806041-035','10806041-036','10806041-037','10806041-038','10806041-039','10806041-040','10806042-001','10806042-002','10806042-003','10806042-004','10806042-005','10806042-008','10806042-011','10806042-012','10806042-014','10806042-016','10806042-017','10806042-018','10806042-019','10806042-021','10806042-022','10806042-023','10806042-024','10806042-025','10806042-026','10806042-028','10806042-033','10806042-034','10806042-035','10806042-036','10806042-037','10806042-038','10806042-039','10806042-040','10806051','10806061','10806062','30806501','30806502','30806503','30806504'])
                queries.append(q)           
            if subjectno == 'a':
                q_kwargs['subjectno'] = subjectno
                q = Q(subjectno__in=['10806111','10806112','10806113','10806114','10806115','10806116','10806121','10806122','10806123','10806124','10806125','10806126','10806127','10806131','10806132','10806133','10806134','10806135','10806211','10806212','10806213','10806214','10806215','10806231','10806233','10806234','10806311','10806312','10806313','10806314','10806321','10806322','10806323','10806324','10806325','10806331','10806332','10806411','10806412','10806421','10806422','10806423','10806431','10806432','10806433','10806461','10806471','30810003','30810004','30810007','30810008','30810009','30810010','30810011','30810012','30810013','30810014','30820001','30820002','30820003','30820004','30820005','30820006','30820007','30820008','30820009','30820010','30820011','30820012','30830001','30830002','30830003','30830004','30830005','30830006','30830007','30830008','30830009','30830010','30830011','30830012','10806221','10806222','10806223','10806224','10806225','10807122','10807126','10807221','10807225','10807324','10807325'])
                queries.append(q)
            if subjectno == 'b':
                q_kwargs['subjectno'] = subjectno
                q = Q(subjectno__in=['10807411-001','10807412-001','10807413-001','10807413-003','10807414-001','10807414-003','10806511-002','10806512-002','10806513-002','10806514-002','10806521','10806522','10806523','10806524','10806531','10806532','10806533','10806534','10806535','10806536','10806611','10806612-001','10806612-002','10806612-003','10806613-001','10806613-002','10806614','10806621','10806622','10806623','10806624','10806631','10806632','10806633','10806671','10806711','10806712','10806714','10806717','10806721','10806722','10806723','10806724','10806725','10806726','10806731','10806732','10806733','10806751','10806752','10806753','10806762','10806763','10806773','10806774','10807513-001','10807513-002','10807515','10807522','10807523','10807524','10807525','30840001','30840002','30840003','30840004','30840005','30840006','30840007','30840008','30840009','30840010','30840011','30840015','30840016'])
                queries.append(q)
            if subjectno == 'c':
                q_kwargs['subjectno'] = subjectno
                q = Q(subjectno__in=['10806811-001','10806811-004','10806811-006','10806811-008','10806811-009','10806811-012','10806811-013','10806811-014','10806811-015','10806851','10806854','10806856','10806858','10806859','10806862','10806863','10806864','10806865','10807851','10807854','10807856','10807858','10807859','10807862','10807864','10807865'])
                queries.append(q)
            if subjectno == 'o':
                q_kwargs['subjectno'] = subjectno
                q = Q(subjectno__in=['10809110','10809111-001','10809111-002','10809111-003','10809111-004','10809114-001','10809114-003','10809115-001','10809115-003','10809116-001','10809116-003','10809117-001','10809117-003','10809118-001','10809118-002','10809119-001','10809119-002','10809120','10809125-001','10809125-051','10809126-001','10809126-003','10809127-001','10809127-003','30806601','30806602','30806603','30806604','30806605','30806701','30806702','30806705','30806706','30806707-001','30806707-002','30806708-001','30806708-002'])
                queries.append(q)
        if queries:
            base_query = queries.pop()
            for query in queries:
                base_query &= query
                print(base_query)
            data = data.filter(base_query)


    params = {
        'title': 'Bunjho_2018_AllSubjectData',
        'message': '2019/10/7',
        'data': data,
        'formset': formset,
    }
    return render(request, 'index.html', params)